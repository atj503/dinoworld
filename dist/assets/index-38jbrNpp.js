import{V as e,a as t,C as n,L as s,b as r,F as i,T as o,R as a,c as l,d as c,M as h,e as u,f as p,S as d,E as f,g as m,G as g,B as v,P as y,O as w,h as x,i as b,j as I,k as T,l as D,D as A,m as P,n as E,o as R,p as C,q as k,A as N,r as S,s as L,U as M,t as O,u as F,v as z,w as U,x as B,Q as j,y as G,z as V,N as W,H as _,I as X,J as H,K,W as $,X as Y,Y as Z,Z as q,_ as Q,$ as J,a0 as ee}from"./three-CS6zCq0A.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();
/*!
fflate - fast JavaScript compression/decompression
<https://101arrowz.github.io/fflate>
Licensed under MIT. https://github.com/101arrowz/fflate/blob/master/LICENSE
version 0.6.9
*/
var te=function(e){return URL.createObjectURL(new Blob([e],{type:"text/javascript"}))};try{URL.revokeObjectURL(te(""))}catch(ft){te=function(e){return"data:application/javascript;charset=UTF-8,"+encodeURI(e)}}var ne=Uint8Array,se=Uint16Array,re=Uint32Array,ie=new ne([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),oe=new ne([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),ae=new ne([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),le=function(e,t){for(var n=new se(31),s=0;s<31;++s)n[s]=t+=1<<e[s-1];var r=new re(n[30]);for(s=1;s<30;++s)for(var i=n[s];i<n[s+1];++i)r[i]=i-n[s]<<5|s;return[n,r]},ce=le(ie,2),he=ce[0],ue=ce[1];he[28]=258,ue[258]=28;for(var pe=le(oe,0)[0],de=new se(32768),fe=0;fe<32768;++fe){var me=(43690&fe)>>>1|(21845&fe)<<1;me=(61680&(me=(52428&me)>>>2|(13107&me)<<2))>>>4|(3855&me)<<4,de[fe]=((65280&me)>>>8|(255&me)<<8)>>>1}var ge=function(e,t,n){for(var s=e.length,r=0,i=new se(t);r<s;++r)++i[e[r]-1];var o,a=new se(t);for(r=0;r<t;++r)a[r]=a[r-1]+i[r-1]<<1;if(n){o=new se(1<<t);var l=15-t;for(r=0;r<s;++r)if(e[r])for(var c=r<<4|e[r],h=t-e[r],u=a[e[r]-1]++<<h,p=u|(1<<h)-1;u<=p;++u)o[de[u]>>>l]=c}else for(o=new se(s),r=0;r<s;++r)e[r]&&(o[r]=de[a[e[r]-1]++]>>>15-e[r]);return o},ve=new ne(288);for(fe=0;fe<144;++fe)ve[fe]=8;for(fe=144;fe<256;++fe)ve[fe]=9;for(fe=256;fe<280;++fe)ve[fe]=7;for(fe=280;fe<288;++fe)ve[fe]=8;var ye=new ne(32);for(fe=0;fe<32;++fe)ye[fe]=5;var we=ge(ve,9,1),xe=ge(ye,5,1),be=function(e){for(var t=e[0],n=1;n<e.length;++n)e[n]>t&&(t=e[n]);return t},Ie=function(e,t,n){var s=t/8|0;return(e[s]|e[s+1]<<8)>>(7&t)&n},Te=function(e,t){var n=t/8|0;return(e[n]|e[n+1]<<8|e[n+2]<<16)>>(7&t)},De=function(e,t,n){var s=e.length;if(!s||n&&!n.l&&s<5)return t||new ne(0);var r=!t||n,i=!n||n.i;n||(n={}),t||(t=new ne(3*s));var o,a=function(e){var n=t.length;if(e>n){var s=new ne(Math.max(2*n,e));s.set(t),t=s}},l=n.f||0,c=n.p||0,h=n.b||0,u=n.l,p=n.d,d=n.m,f=n.n,m=8*s;do{if(!u){n.f=l=Ie(e,c,1);var g=Ie(e,c+1,3);if(c+=3,!g){var v=e[(R=((o=c)/8|0)+(7&o&&1)+4)-4]|e[R-3]<<8,y=R+v;if(y>s){if(i)throw"unexpected EOF";break}r&&a(h+v),t.set(e.subarray(R,y),h),n.b=h+=v,n.p=c=8*y;continue}if(1==g)u=we,p=xe,d=9,f=5;else{if(2!=g)throw"invalid block type";var w=Ie(e,c,31)+257,x=Ie(e,c+10,15)+4,b=w+Ie(e,c+5,31)+1;c+=14;for(var I=new ne(b),T=new ne(19),D=0;D<x;++D)T[ae[D]]=Ie(e,c+3*D,7);c+=3*x;var A=be(T),P=(1<<A)-1,E=ge(T,A,1);for(D=0;D<b;){var R,C=E[Ie(e,c,P)];if(c+=15&C,(R=C>>>4)<16)I[D++]=R;else{var k=0,N=0;for(16==R?(N=3+Ie(e,c,3),c+=2,k=I[D-1]):17==R?(N=3+Ie(e,c,7),c+=3):18==R&&(N=11+Ie(e,c,127),c+=7);N--;)I[D++]=k}}var S=I.subarray(0,w),L=I.subarray(w);d=be(S),f=be(L),u=ge(S,d,1),p=ge(L,f,1)}if(c>m){if(i)throw"unexpected EOF";break}}r&&a(h+131072);for(var M=(1<<d)-1,O=(1<<f)-1,F=c;;F=c){var z=(k=u[Te(e,c)&M])>>>4;if((c+=15&k)>m){if(i)throw"unexpected EOF";break}if(!k)throw"invalid length/literal";if(z<256)t[h++]=z;else{if(256==z){F=c,u=null;break}var U=z-254;if(z>264){var B=ie[D=z-257];U=Ie(e,c,(1<<B)-1)+he[D],c+=B}var j=p[Te(e,c)&O],G=j>>>4;if(!j)throw"invalid distance";c+=15&j;L=pe[G];if(G>3){B=oe[G];L+=Te(e,c)&(1<<B)-1,c+=B}if(c>m){if(i)throw"unexpected EOF";break}r&&a(h+131072);for(var V=h+U;h<V;h+=4)t[h]=t[h-L],t[h+1]=t[h+1-L],t[h+2]=t[h+2-L],t[h+3]=t[h+3-L];h=V}}n.l=u,n.p=F,n.b=h,u&&(l=1,n.m=d,n.d=p,n.n=f)}while(!l);return h==t.length?t:function(e,t,n){(null==n||n>e.length)&&(n=e.length);var s=new(e instanceof se?se:e instanceof re?re:ne)(n-t);return s.set(e.subarray(t,n)),s}(t,0,h)},Ae=new ne(0);var Pe="undefined"!=typeof TextDecoder&&new TextDecoder;try{Pe.decode(Ae,{stream:!0})}catch(ft){}function Ee(e,t,n){const s=n.length-e-1;if(t>=n[s])return s-1;if(t<=n[e])return e;let r=e,i=s,o=Math.floor((r+i)/2);for(;t<n[o]||t>=n[o+1];)t<n[o]?i=o:r=o,o=Math.floor((r+i)/2);return o}function Re(e,t){let n=1;for(let r=2;r<=e;++r)n*=r;let s=1;for(let r=2;r<=t;++r)s*=r;for(let r=2;r<=e-t;++r)s*=r;return n/s}function Ce(n,s,r,i,o){const a=function(t,n,s,r,i){const o=i<t?i:t,a=[],l=Ee(t,r,n),c=function(e,t,n,s,r){const i=[];for(let u=0;u<=n;++u)i[u]=0;const o=[];for(let u=0;u<=s;++u)o[u]=i.slice(0);const a=[];for(let u=0;u<=n;++u)a[u]=i.slice(0);a[0][0]=1;const l=i.slice(0),c=i.slice(0);for(let u=1;u<=n;++u){l[u]=t-r[e+1-u],c[u]=r[e+u]-t;let n=0;for(let e=0;e<u;++e){const t=c[e+1],s=l[u-e];a[u][e]=t+s;const r=a[e][u-1]/a[u][e];a[e][u]=n+t*r,n=s*r}a[u][u]=n}for(let u=0;u<=n;++u)o[0][u]=a[u][n];for(let u=0;u<=n;++u){let e=0,t=1;const r=[];for(let s=0;s<=n;++s)r[s]=i.slice(0);r[0][0]=1;for(let i=1;i<=s;++i){let s=0;const l=u-i,c=n-i;u>=i&&(r[t][0]=r[e][0]/a[c+1][l],s=r[t][0]*a[l][c]);const h=u-1<=c?i-1:n-u;for(let n=l>=-1?1:-l;n<=h;++n)r[t][n]=(r[e][n]-r[e][n-1])/a[c+1][l+n],s+=r[t][n]*a[l+n][c];u<=c&&(r[t][i]=-r[e][i-1]/a[c+1][u],s+=r[t][i]*a[u][c]),o[i][u]=s;const p=e;e=t,t=p}}let h=n;for(let u=1;u<=s;++u){for(let e=0;e<=n;++e)o[u][e]*=h;h*=n-u}return o}(l,r,t,o,n),h=[];for(let e=0;e<s.length;++e){const t=s[e].clone(),n=t.w;t.x*=n,t.y*=n,t.z*=n,h[e]=t}for(let e=0;e<=o;++e){const n=h[l-t].clone().multiplyScalar(c[e][0]);for(let s=1;s<=t;++s)n.add(h[l-t+s].clone().multiplyScalar(c[e][s]));a[e]=n}for(let u=o+1;u<=i+1;++u)a[u]=new e(0,0,0);return a}(n,s,r,i,o);return function(e){const n=e.length,s=[],r=[];for(let o=0;o<n;++o){const n=e[o];s[o]=new t(n.x,n.y,n.z),r[o]=n.w}const i=[];for(let t=0;t<n;++t){const e=s[t].clone();for(let n=1;n<=t;++n)e.sub(i[t-n].clone().multiplyScalar(Re(t,n)*r[n]));i[t]=e.divideScalar(r[0])}return i}(a)}class ke extends n{constructor(t,n,s,r,i){super(),this.degree=t,this.knots=n,this.controlPoints=[],this.startKnot=r||0,this.endKnot=i||this.knots.length-1;for(let o=0;o<s.length;++o){const t=s[o];this.controlPoints[o]=new e(t.x,t.y,t.z,t.w)}}getPoint(n,s=new t){const r=s,i=this.knots[this.startKnot]+n*(this.knots[this.endKnot]-this.knots[this.startKnot]),o=function(t,n,s,r){const i=Ee(t,r,n),o=function(e,t,n,s){const r=[],i=[],o=[];r[0]=1;for(let a=1;a<=n;++a){i[a]=t-s[e+1-a],o[a]=s[e+a]-t;let n=0;for(let e=0;e<a;++e){const t=o[e+1],s=i[a-e],l=r[e]/(t+s);r[e]=n+t*l,n=s*l}r[a]=n}return r}(i,r,t,n),a=new e(0,0,0,0);for(let e=0;e<=t;++e){const n=s[i-t+e],r=o[e],l=n.w*r;a.x+=n.x*l,a.y+=n.y*l,a.z+=n.z*l,a.w+=n.w*r}return a}(this.degree,this.knots,this.controlPoints,i);return 1!==o.w&&o.divideScalar(o.w),r.set(o.x,o.y,o.z)}getTangent(e,n=new t){const s=n,r=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),i=Ce(this.degree,this.knots,this.controlPoints,r,1);return s.copy(i[1]).normalize(),s}}let Ne,Se,Le;class Me extends s{constructor(e){super(e)}load(e,t,n,s){const o=this,a=""===o.path?r.extractUrlBase(e):o.path,l=new i(this.manager);l.setPath(o.path),l.setResponseType("arraybuffer"),l.setRequestHeader(o.requestHeader),l.setWithCredentials(o.withCredentials),l.load(e,(function(n){try{t(o.parse(n,a))}catch(ft){s&&s(ft),o.manager.itemError(e)}}),n,s)}parse(e,t){if(function(e){const t="Kaydara FBX Binary  \0";return e.byteLength>=t.length&&t===qe(e,0,t.length)}(e))Ne=(new Be).parse(e);else{const t=qe(e);if(!function(e){const t=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let n=0;function s(t){const s=e[t-1];return e=e.slice(n+t),n++,s}for(let r=0;r<t.length;++r){if(s(1)===t[r])return!1}return!0}(t))throw new Error("THREE.FBXLoader: Unknown format.");if(Ve(t)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+Ve(t));Ne=(new Ue).parse(t)}const n=new o(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new Oe(n,this.manager).parse(Ne)}}class Oe{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){Se=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),n=this.parseMaterials(t),s=this.parseDeformers(),r=(new Fe).parse(s);return this.parseScene(s,r,n),Le}parseConnections(){const e=new Map;if("Connections"in Ne){Ne.Connections.connections.forEach((function(t){const n=t[0],s=t[1],r=t[2];e.has(n)||e.set(n,{parents:[],children:[]});const i={ID:s,relationship:r};e.get(n).parents.push(i),e.has(s)||e.set(s,{parents:[],children:[]});const o={ID:n,relationship:r};e.get(s).children.push(o)}))}return e}parseImages(){const e={},t={};if("Video"in Ne.Objects){const n=Ne.Objects.Video;for(const s in n){const r=n[s];if(e[parseInt(s)]=r.RelativeFilename||r.Filename,"Content"in r){const e=r.Content instanceof ArrayBuffer&&r.Content.byteLength>0,i="string"==typeof r.Content&&""!==r.Content;if(e||i){const e=this.parseImage(n[s]);t[r.RelativeFilename||r.Filename]=e}}}}for(const n in e){const s=e[n];void 0!==t[s]?e[n]=t[s]:e[n]=e[n].split("\\").pop()}return e}parseImage(e){const t=e.Content,n=e.RelativeFilename||e.Filename;let s;switch(n.slice(n.lastIndexOf(".")+1).toLowerCase()){case"bmp":s="image/bmp";break;case"jpg":case"jpeg":s="image/jpeg";break;case"png":s="image/png";break;case"tif":s="image/tiff";break;case"tga":this.manager.getHandler(".tga"),s="image/tga";break;default:return}if("string"==typeof t)return"data:"+s+";base64,"+t;{const e=new Uint8Array(t);return window.URL.createObjectURL(new Blob([e],{type:s}))}}parseTextures(e){const t=new Map;if("Texture"in Ne.Objects){const n=Ne.Objects.Texture;for(const s in n){const r=this.parseTexture(n[s],e);t.set(parseInt(s),r)}}return t}parseTexture(e,t){const n=this.loadTexture(e,t);n.ID=e.id,n.name=e.attrName;const s=e.WrapModeU,r=e.WrapModeV,i=void 0!==s?s.value:0,o=void 0!==r?r.value:0;if(n.wrapS=0===i?a:l,n.wrapT=0===o?a:l,"Scaling"in e){const t=e.Scaling.value;n.repeat.x=t[0],n.repeat.y=t[1]}if("Translation"in e){const t=e.Translation.value;n.offset.x=t[0],n.offset.y=t[1]}return n}loadTexture(e,t){let n;const s=this.textureLoader.path,r=Se.get(e.id).children;let i;void 0!==r&&r.length>0&&void 0!==t[r[0].ID]&&(n=t[r[0].ID],0!==n.indexOf("blob:")&&0!==n.indexOf("data:")||this.textureLoader.setPath(void 0));const o=e.FileName.slice(-3).toLowerCase();if("tga"===o){const e=this.manager.getHandler(".tga");null===e?i=new c:(e.setPath(this.textureLoader.path),i=e.load(n))}else if("dds"===o){const e=this.manager.getHandler(".dds");null===e?i=new c:(e.setPath(this.textureLoader.path),i=e.load(n))}else i="psd"===o?new c:this.textureLoader.load(n);return this.textureLoader.setPath(s),i}parseMaterials(e){const t=new Map;if("Material"in Ne.Objects){const n=Ne.Objects.Material;for(const s in n){const r=this.parseMaterial(n[s],e);null!==r&&t.set(parseInt(s),r)}}return t}parseMaterial(e,t){const n=e.id,s=e.attrName;let r=e.ShadingModel;if("object"==typeof r&&(r=r.value),!Se.has(n))return null;const i=this.parseParameters(e,t,n);let o;switch(r.toLowerCase()){case"phong":default:o=new h;break;case"lambert":o=new u}return o.setValues(i),o.name=s,o}parseParameters(e,t,n){const s={};e.BumpFactor&&(s.bumpScale=e.BumpFactor.value),e.Diffuse?s.color=(new p).fromArray(e.Diffuse.value).convertSRGBToLinear():!e.DiffuseColor||"Color"!==e.DiffuseColor.type&&"ColorRGB"!==e.DiffuseColor.type||(s.color=(new p).fromArray(e.DiffuseColor.value).convertSRGBToLinear()),e.DisplacementFactor&&(s.displacementScale=e.DisplacementFactor.value),e.Emissive?s.emissive=(new p).fromArray(e.Emissive.value).convertSRGBToLinear():!e.EmissiveColor||"Color"!==e.EmissiveColor.type&&"ColorRGB"!==e.EmissiveColor.type||(s.emissive=(new p).fromArray(e.EmissiveColor.value).convertSRGBToLinear()),e.EmissiveFactor&&(s.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(s.opacity=parseFloat(e.Opacity.value)),s.opacity<1&&(s.transparent=!0),e.ReflectionFactor&&(s.reflectivity=e.ReflectionFactor.value),e.Shininess&&(s.shininess=e.Shininess.value),e.Specular?s.specular=(new p).fromArray(e.Specular.value).convertSRGBToLinear():e.SpecularColor&&"Color"===e.SpecularColor.type&&(s.specular=(new p).fromArray(e.SpecularColor.value).convertSRGBToLinear());const r=this;return Se.get(n).children.forEach((function(e){switch(e.relationship){case"Bump":s.bumpMap=r.getTexture(t,e.ID);break;case"Maya|TEX_ao_map":s.aoMap=r.getTexture(t,e.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":s.map=r.getTexture(t,e.ID),void 0!==s.map&&(s.map.colorSpace=d);break;case"DisplacementColor":s.displacementMap=r.getTexture(t,e.ID);break;case"EmissiveColor":s.emissiveMap=r.getTexture(t,e.ID),void 0!==s.emissiveMap&&(s.emissiveMap.colorSpace=d);break;case"NormalMap":case"Maya|TEX_normal_map":s.normalMap=r.getTexture(t,e.ID);break;case"ReflectionColor":s.envMap=r.getTexture(t,e.ID),void 0!==s.envMap&&(s.envMap.mapping=f,s.envMap.colorSpace=d);break;case"SpecularColor":s.specularMap=r.getTexture(t,e.ID),void 0!==s.specularMap&&(s.specularMap.colorSpace=d);break;case"TransparentColor":case"TransparencyFactor":s.alphaMap=r.getTexture(t,e.ID),s.transparent=!0}})),s}getTexture(e,t){return"LayeredTexture"in Ne.Objects&&t in Ne.Objects.LayeredTexture&&(t=Se.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in Ne.Objects){const n=Ne.Objects.Deformer;for(const s in n){const r=n[s],i=Se.get(parseInt(s));if("Skin"===r.attrType){const t=this.parseSkeleton(i,n);t.ID=s,i.parents.length,t.geometryID=i.parents[0].ID,e[s]=t}else if("BlendShape"===r.attrType){const e={id:s};e.rawTargets=this.parseMorphTargets(i,n),e.id=s,i.parents.length,t[s]=e}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const n=[];return e.children.forEach((function(e){const s=t[e.ID];if("Cluster"!==s.attrType)return;const r={ID:e.ID,indices:[],weights:[],transformLink:(new m).fromArray(s.TransformLink.a)};"Indexes"in s&&(r.indices=s.Indexes.a,r.weights=s.Weights.a),n.push(r)})),{rawBones:n,bones:[]}}parseMorphTargets(e,t){const n=[];for(let s=0;s<e.children.length;s++){const r=e.children[s],i=t[r.ID],o={name:i.attrName,initialWeight:i.DeformPercent,id:i.id,fullWeights:i.FullWeights.a};if("BlendShapeChannel"!==i.attrType)return;o.geoID=Se.get(parseInt(r.ID)).children.filter((function(e){return void 0===e.relationship}))[0].ID,n.push(o)}return n}parseScene(e,t,n){Le=new g;const s=this.parseModels(e.skeletons,t,n),r=Ne.Objects.Model,i=this;s.forEach((function(e){const t=r[e.ID];i.setLookAtProperties(e,t);Se.get(e.ID).parents.forEach((function(t){const n=s.get(t.ID);void 0!==n&&n.add(e)})),null===e.parent&&Le.add(e)})),this.bindSkeleton(e.skeletons,t,s),this.addGlobalSceneSettings(),Le.traverse((function(e){if(e.userData.transformData){e.parent&&(e.userData.transformData.parentMatrix=e.parent.matrix,e.userData.transformData.parentMatrixWorld=e.parent.matrixWorld);const t=$e(e.userData.transformData);e.applyMatrix4(t),e.updateWorldMatrix()}}));const o=(new ze).parse();1===Le.children.length&&Le.children[0].isGroup&&(Le.children[0].animations=o,Le=Le.children[0]),Le.animations=o}parseModels(e,t,n){const s=new Map,r=Ne.Objects.Model;for(const i in r){const o=parseInt(i),a=r[i],l=Se.get(o);let c=this.buildSkeleton(l,e,o,a.attrName);if(!c){switch(a.attrType){case"Camera":c=this.createCamera(l);break;case"Light":c=this.createLight(l);break;case"Mesh":c=this.createMesh(l,t,n);break;case"NurbsCurve":c=this.createCurve(l,t);break;case"LimbNode":case"Root":c=new v;break;default:c=new g}c.name=a.attrName?y.sanitizeNodeName(a.attrName):"",c.userData.originalName=a.attrName,c.ID=o}this.getTransformData(c,a),s.set(o,c)}return s}buildSkeleton(e,t,n,s){let r=null;return e.parents.forEach((function(e){for(const i in t){const o=t[i];o.rawBones.forEach((function(t,i){if(t.ID===e.ID){const e=r;r=new v,r.matrixWorld.copy(t.transformLink),r.name=s?y.sanitizeNodeName(s):"",r.userData.originalName=s,r.ID=n,o.bones[i]=r,null!==e&&r.add(e)}}))}})),r}createCamera(e){let t,n;if(e.children.forEach((function(e){const t=Ne.Objects.NodeAttribute[e.ID];void 0!==t&&(n=t)})),void 0===n)t=new w;else{let e=0;void 0!==n.CameraProjectionType&&1===n.CameraProjectionType.value&&(e=1);let s=1;void 0!==n.NearPlane&&(s=n.NearPlane.value/1e3);let r=1e3;void 0!==n.FarPlane&&(r=n.FarPlane.value/1e3);let i=window.innerWidth,o=window.innerHeight;void 0!==n.AspectWidth&&void 0!==n.AspectHeight&&(i=n.AspectWidth.value,o=n.AspectHeight.value);const a=i/o;let l=45;void 0!==n.FieldOfView&&(l=n.FieldOfView.value);const c=n.FocalLength?n.FocalLength.value:null;switch(e){case 0:t=new b(l,a,s,r),null!==c&&t.setFocalLength(c);break;case 1:t=new x(-i/2,i/2,o/2,-o/2,s,r);break;default:t=new w}}return t}createLight(e){let t,n;if(e.children.forEach((function(e){const t=Ne.Objects.NodeAttribute[e.ID];void 0!==t&&(n=t)})),void 0===n)t=new w;else{let e;e=void 0===n.LightType?0:n.LightType.value;let s=16777215;void 0!==n.Color&&(s=(new p).fromArray(n.Color.value).convertSRGBToLinear());let r=void 0===n.Intensity?1:n.Intensity.value/100;void 0!==n.CastLightOnObject&&0===n.CastLightOnObject.value&&(r=0);let i=0;void 0!==n.FarAttenuationEnd&&(i=void 0!==n.EnableFarAttenuation&&0===n.EnableFarAttenuation.value?0:n.FarAttenuationEnd.value);const o=1;switch(e){case 0:t=new I(s,r,i,o);break;case 1:t=new A(s,r);break;case 2:let e=Math.PI/3;void 0!==n.InnerAngle&&(e=T.degToRad(n.InnerAngle.value));let a=0;void 0!==n.OuterAngle&&(a=T.degToRad(n.OuterAngle.value),a=Math.max(a,1)),t=new D(s,r,i,e,a,o);break;default:t=new I(s,r)}void 0!==n.CastShadows&&1===n.CastShadows.value&&(t.castShadow=!0)}return t}createMesh(e,t,n){let r,i=null,o=null;const a=[];return e.children.forEach((function(e){t.has(e.ID)&&(i=t.get(e.ID)),n.has(e.ID)&&a.push(n.get(e.ID))})),a.length>1?o=a:a.length>0?o=a[0]:(o=new h({name:s.DEFAULT_MATERIAL_NAME,color:13421772}),a.push(o)),"color"in i.attributes&&a.forEach((function(e){e.vertexColors=!0})),i.FBX_Deformer?(r=new P(i,o),r.normalizeSkinWeights()):r=new E(i,o),r}createCurve(e,t){const n=e.children.reduce((function(e,n){return t.has(n.ID)&&(e=t.get(n.ID)),e}),null),r=new R({name:s.DEFAULT_MATERIAL_NAME,color:3342591,linewidth:1});return new C(n,r)}getTransformData(e,t){const n={};"InheritType"in t&&(n.inheritType=parseInt(t.InheritType.value)),n.eulerOrder="RotationOrder"in t?Ye(t.RotationOrder.value):"ZYX","Lcl_Translation"in t&&(n.translation=t.Lcl_Translation.value),"PreRotation"in t&&(n.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(n.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(n.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(n.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(n.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(n.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(n.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(n.rotationPivot=t.RotationPivot.value),e.userData.transformData=n}setLookAtProperties(e,n){if("LookAtProperty"in n){Se.get(e.ID).children.forEach((function(n){if("LookAtProperty"===n.relationship){const s=Ne.Objects.Model[n.ID];if("Lcl_Translation"in s){const n=s.Lcl_Translation.value;void 0!==e.target?(e.target.position.fromArray(n),Le.add(e.target)):e.lookAt((new t).fromArray(n))}}}))}}bindSkeleton(e,t,n){const s=this.parsePoseNodes();for(const r in e){const i=e[r];Se.get(parseInt(i.ID)).parents.forEach((function(e){if(t.has(e.ID)){const t=e.ID;Se.get(t).parents.forEach((function(e){if(n.has(e.ID)){n.get(e.ID).bind(new k(i.bones),s[e.ID])}}))}}))}}parsePoseNodes(){const e={};if("Pose"in Ne.Objects){const t=Ne.Objects.Pose;for(const n in t)if("BindPose"===t[n].attrType&&t[n].NbPoseNodes>0){const s=t[n].PoseNode;Array.isArray(s)?s.forEach((function(t){e[t.Node]=(new m).fromArray(t.Matrix.a)})):e[s.Node]=(new m).fromArray(s.Matrix.a)}}return e}addGlobalSceneSettings(){if("GlobalSettings"in Ne){if("AmbientColor"in Ne.GlobalSettings){const e=Ne.GlobalSettings.AmbientColor.value,t=e[0],n=e[1],s=e[2];if(0!==t||0!==n||0!==s){const e=new p(t,n,s).convertSRGBToLinear();Le.add(new N(e,1))}}"UnitScaleFactor"in Ne.GlobalSettings&&(Le.userData.unitScaleFactor=Ne.GlobalSettings.UnitScaleFactor.value)}}}class Fe{constructor(){this.negativeMaterialIndices=!1}parse(e){const t=new Map;if("Geometry"in Ne.Objects){const n=Ne.Objects.Geometry;for(const s in n){const r=Se.get(parseInt(s)),i=this.parseGeometry(r,n[s],e);t.set(parseInt(s),i)}}return this.negativeMaterialIndices,t}parseGeometry(e,t,n){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,n);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,n){const s=n.skeletons,r=[],i=e.parents.map((function(e){return Ne.Objects.Model[e.ID]}));if(0===i.length)return;const o=e.children.reduce((function(e,t){return void 0!==s[t.ID]&&(e=s[t.ID]),e}),null);e.children.forEach((function(e){void 0!==n.morphTargets[e.ID]&&r.push(n.morphTargets[e.ID])}));const a=i[0],l={};"RotationOrder"in a&&(l.eulerOrder=Ye(a.RotationOrder.value)),"InheritType"in a&&(l.inheritType=parseInt(a.InheritType.value)),"GeometricTranslation"in a&&(l.translation=a.GeometricTranslation.value),"GeometricRotation"in a&&(l.rotation=a.GeometricRotation.value),"GeometricScaling"in a&&(l.scale=a.GeometricScaling.value);const c=$e(l);return this.genGeometry(t,o,r,c)}genGeometry(e,t,n,s){const r=new S;e.attrName&&(r.name=e.attrName);const i=this.parseGeoNode(e,t),o=this.genBuffers(i),a=new L(o.vertex,3);if(a.applyMatrix4(s),r.setAttribute("position",a),o.colors.length>0&&r.setAttribute("color",new L(o.colors,3)),t&&(r.setAttribute("skinIndex",new M(o.weightsIndices,4)),r.setAttribute("skinWeight",new L(o.vertexWeights,4)),r.FBX_Deformer=t),o.normal.length>0){const e=(new O).getNormalMatrix(s),t=new L(o.normal,3);t.applyNormalMatrix(e),r.setAttribute("normal",t)}if(o.uvs.forEach((function(e,t){const n=0===t?"uv":`uv${t}`;r.setAttribute(n,new L(o.uvs[t],2))})),i.material&&"AllSame"!==i.material.mappingType){let e=o.materialIndex[0],t=0;if(o.materialIndex.forEach((function(n,s){n!==e&&(r.addGroup(t,s-t,e),e=n,t=s)})),r.groups.length>0){const t=r.groups[r.groups.length-1],n=t.start+t.count;n!==o.materialIndex.length&&r.addGroup(n,o.materialIndex.length-n,e)}0===r.groups.length&&r.addGroup(0,o.materialIndex.length,o.materialIndex[0])}return this.addMorphTargets(r,e,n,s),r}parseGeoNode(e,t){const n={};if(n.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],n.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(n.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(n.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(n.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){n.uv=[];let t=0;for(;e.LayerElementUV[t];)e.LayerElementUV[t].UV&&n.uv.push(this.parseUVs(e.LayerElementUV[t])),t++}return n.weightTable={},null!==t&&(n.skeleton=t,t.rawBones.forEach((function(e,t){e.indices.forEach((function(s,r){void 0===n.weightTable[s]&&(n.weightTable[s]=[]),n.weightTable[s].push({id:t,weight:e.weights[r]})}))}))),n}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let n=0,s=0,r=!1,i=[],o=[],a=[],l=[],c=[],h=[];const u=this;return e.vertexIndices.forEach((function(p,d){let f,m=!1;p<0&&(p=~p,m=!0);let g=[],v=[];if(i.push(3*p,3*p+1,3*p+2),e.color){const t=Xe(d,n,p,e.color);a.push(t[0],t[1],t[2])}if(e.skeleton){if(void 0!==e.weightTable[p]&&e.weightTable[p].forEach((function(e){v.push(e.weight),g.push(e.id)})),v.length>4){r||(r=!0);const e=[0,0,0,0],t=[0,0,0,0];v.forEach((function(n,s){let r=n,i=g[s];t.forEach((function(t,n,s){if(r>t){s[n]=r,r=t;const o=e[n];e[n]=i,i=o}}))})),g=e,v=t}for(;v.length<4;)v.push(0),g.push(0);for(let e=0;e<4;++e)c.push(v[e]),h.push(g[e])}if(e.normal){const t=Xe(d,n,p,e.normal);o.push(t[0],t[1],t[2])}e.material&&"AllSame"!==e.material.mappingType&&(f=Xe(d,n,p,e.material)[0],f<0&&(u.negativeMaterialIndices=!0,f=0)),e.uv&&e.uv.forEach((function(e,t){const s=Xe(d,n,p,e);void 0===l[t]&&(l[t]=[]),l[t].push(s[0]),l[t].push(s[1])})),s++,m&&(u.genFace(t,e,i,f,o,a,l,c,h,s),n++,s=0,i=[],o=[],a=[],l=[],c=[],h=[])})),t}getNormalNewell(e){const n=new t(0,0,0);for(let t=0;t<e.length;t++){const s=e[t],r=e[(t+1)%e.length];n.x+=(s.y-r.y)*(s.z+r.z),n.y+=(s.z-r.z)*(s.x+r.x),n.z+=(s.x-r.x)*(s.y+r.y)}return n.normalize(),n}getNormalTangentAndBitangent(e){const n=this.getNormalNewell(e),s=(Math.abs(n.z)>.5?new t(0,1,0):new t(0,0,1)).cross(n).normalize(),r=n.clone().cross(s).normalize();return{normal:n,tangent:s,bitangent:r}}flattenVertex(e,t,n){return new F(e.dot(t),e.dot(n))}genFace(e,n,s,r,i,o,a,l,c,h){let u;if(h>3){const e=[];for(let a=0;a<s.length;a+=3)e.push(new t(n.vertexPositions[s[a]],n.vertexPositions[s[a+1]],n.vertexPositions[s[a+2]]));const{tangent:r,bitangent:i}=this.getNormalTangentAndBitangent(e),o=[];for(const t of e)o.push(this.flattenVertex(t,r,i));u=z.triangulateShape(o,[])}else u=[[0,1,2]];for(const[t,p,d]of u)e.vertex.push(n.vertexPositions[s[3*t]]),e.vertex.push(n.vertexPositions[s[3*t+1]]),e.vertex.push(n.vertexPositions[s[3*t+2]]),e.vertex.push(n.vertexPositions[s[3*p]]),e.vertex.push(n.vertexPositions[s[3*p+1]]),e.vertex.push(n.vertexPositions[s[3*p+2]]),e.vertex.push(n.vertexPositions[s[3*d]]),e.vertex.push(n.vertexPositions[s[3*d+1]]),e.vertex.push(n.vertexPositions[s[3*d+2]]),n.skeleton&&(e.vertexWeights.push(l[4*t]),e.vertexWeights.push(l[4*t+1]),e.vertexWeights.push(l[4*t+2]),e.vertexWeights.push(l[4*t+3]),e.vertexWeights.push(l[4*p]),e.vertexWeights.push(l[4*p+1]),e.vertexWeights.push(l[4*p+2]),e.vertexWeights.push(l[4*p+3]),e.vertexWeights.push(l[4*d]),e.vertexWeights.push(l[4*d+1]),e.vertexWeights.push(l[4*d+2]),e.vertexWeights.push(l[4*d+3]),e.weightsIndices.push(c[4*t]),e.weightsIndices.push(c[4*t+1]),e.weightsIndices.push(c[4*t+2]),e.weightsIndices.push(c[4*t+3]),e.weightsIndices.push(c[4*p]),e.weightsIndices.push(c[4*p+1]),e.weightsIndices.push(c[4*p+2]),e.weightsIndices.push(c[4*p+3]),e.weightsIndices.push(c[4*d]),e.weightsIndices.push(c[4*d+1]),e.weightsIndices.push(c[4*d+2]),e.weightsIndices.push(c[4*d+3])),n.color&&(e.colors.push(o[3*t]),e.colors.push(o[3*t+1]),e.colors.push(o[3*t+2]),e.colors.push(o[3*p]),e.colors.push(o[3*p+1]),e.colors.push(o[3*p+2]),e.colors.push(o[3*d]),e.colors.push(o[3*d+1]),e.colors.push(o[3*d+2])),n.material&&"AllSame"!==n.material.mappingType&&(e.materialIndex.push(r),e.materialIndex.push(r),e.materialIndex.push(r)),n.normal&&(e.normal.push(i[3*t]),e.normal.push(i[3*t+1]),e.normal.push(i[3*t+2]),e.normal.push(i[3*p]),e.normal.push(i[3*p+1]),e.normal.push(i[3*p+2]),e.normal.push(i[3*d]),e.normal.push(i[3*d+1]),e.normal.push(i[3*d+2])),n.uv&&n.uv.forEach((function(n,s){void 0===e.uvs[s]&&(e.uvs[s]=[]),e.uvs[s].push(a[s][2*t]),e.uvs[s].push(a[s][2*t+1]),e.uvs[s].push(a[s][2*p]),e.uvs[s].push(a[s][2*p+1]),e.uvs[s].push(a[s][2*d]),e.uvs[s].push(a[s][2*d+1])}))}addMorphTargets(e,t,n,s){if(0===n.length)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const r=this;n.forEach((function(n){n.rawTargets.forEach((function(n){const i=Ne.Objects.Geometry[n.geoID];void 0!==i&&r.genMorphGeometry(e,t,i,s,n.name)}))}))}genMorphGeometry(e,t,n,s,r){const i=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],o=void 0!==n.Vertices?n.Vertices.a:[],a=void 0!==n.Indexes?n.Indexes.a:[],l=3*e.attributes.position.count,c=new Float32Array(l);for(let d=0;d<a.length;d++){const e=3*a[d];c[e]=o[3*d],c[e+1]=o[3*d+1],c[e+2]=o[3*d+2]}const h={vertexIndices:i,vertexPositions:c},u=this.genBuffers(h),p=new L(u.vertex,3);p.name=r||n.attrName,p.applyMatrix4(s),e.morphAttributes.position.push(p)}parseNormals(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,s=e.Normals.a;let r=[];return"IndexToDirect"===n&&("NormalIndex"in e?r=e.NormalIndex.a:"NormalsIndex"in e&&(r=e.NormalsIndex.a)),{dataSize:3,buffer:s,indices:r,mappingType:t,referenceType:n}}parseUVs(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,s=e.UV.a;let r=[];return"IndexToDirect"===n&&(r=e.UVIndex.a),{dataSize:2,buffer:s,indices:r,mappingType:t,referenceType:n}}parseVertexColors(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,s=e.Colors.a;let r=[];"IndexToDirect"===n&&(r=e.ColorIndex.a);for(let i=0,o=new p;i<s.length;i+=4)o.fromArray(s,i).convertSRGBToLinear().toArray(s,i);return{dataSize:4,buffer:s,indices:r,mappingType:t,referenceType:n}}parseMaterialIndices(e){const t=e.MappingInformationType,n=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:n};const s=e.Materials.a,r=[];for(let i=0;i<s.length;++i)r.push(i);return{dataSize:1,buffer:s,indices:r,mappingType:t,referenceType:n}}parseNurbsGeometry(t){const n=parseInt(t.Order);if(isNaN(n))return new S;const s=n-1,r=t.KnotVector.a,i=[],o=t.Points.a;for(let h=0,u=o.length;h<u;h+=4)i.push((new e).fromArray(o,h));let a,l;if("Closed"===t.Form)i.push(i[0]);else if("Periodic"===t.Form){a=s,l=r.length-1-a;for(let e=0;e<s;++e)i.push(i[e])}const c=new ke(s,r,i,a,l).getPoints(12*i.length);return(new S).setFromPoints(c)}}class ze{parse(){const e=[],t=this.parseClips();if(void 0!==t)for(const n in t){const s=t[n],r=this.addClip(s);e.push(r)}return e}parseClips(){if(void 0===Ne.Objects.AnimationCurve)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=Ne.Objects.AnimationCurveNode,t=new Map;for(const n in e){const s=e[n];if(null!==s.attrName.match(/S|R|T|DeformPercent/)){const e={id:s.id,attr:s.attrName,curves:{}};t.set(e.id,e)}}return t}parseAnimationCurves(e){const t=Ne.Objects.AnimationCurve;for(const n in t){const s={id:t[n].id,times:t[n].KeyTime.a.map(We),values:t[n].KeyValueFloat.a},r=Se.get(s.id);if(void 0!==r){const t=r.parents[0].ID,n=r.parents[0].relationship;n.match(/X/)?e.get(t).curves.x=s:n.match(/Y/)?e.get(t).curves.y=s:n.match(/Z/)?e.get(t).curves.z=s:n.match(/DeformPercent/)&&e.has(t)&&(e.get(t).curves.morph=s)}}}parseAnimationLayers(e){const t=Ne.Objects.AnimationLayer,n=new Map;for(const s in t){const t=[],r=Se.get(parseInt(s));if(void 0!==r){r.children.forEach((function(n,s){if(e.has(n.ID)){const r=e.get(n.ID);if(void 0!==r.curves.x||void 0!==r.curves.y||void 0!==r.curves.z){if(void 0===t[s]){const e=Se.get(n.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID;if(void 0!==e){const n=Ne.Objects.Model[e.toString()];if(void 0===n)return;const r={modelName:n.attrName?y.sanitizeNodeName(n.attrName):"",ID:n.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};Le.traverse((function(e){e.ID===n.id&&(r.transform=e.matrix,e.userData.transformData&&(r.eulerOrder=e.userData.transformData.eulerOrder))})),r.transform||(r.transform=new m),"PreRotation"in n&&(r.preRotation=n.PreRotation.value),"PostRotation"in n&&(r.postRotation=n.PostRotation.value),t[s]=r}}t[s]&&(t[s][r.attr]=r)}else if(void 0!==r.curves.morph){if(void 0===t[s]){const e=Se.get(n.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID,r=Se.get(e).parents[0].ID,i=Se.get(r).parents[0].ID,o=Se.get(i).parents[0].ID,a=Ne.Objects.Model[o],l={modelName:a.attrName?y.sanitizeNodeName(a.attrName):"",morphName:Ne.Objects.Deformer[e].attrName};t[s]=l}t[s][r.attr]=r}}})),n.set(parseInt(s),t)}}return n}parseAnimStacks(e){const t=Ne.Objects.AnimationStack,n={};for(const s in t){const r=Se.get(parseInt(s)).children;r.length;const i=e.get(r[0].ID);n[s]={name:t[s].attrName,layer:i}}return n}addClip(e){let t=[];const n=this;return e.layer.forEach((function(e){t=t.concat(n.generateTracks(e))})),new B(e.name,-1,t)}generateTracks(e){const n=[];let s=new t,r=new t;if(e.transform&&e.transform.decompose(s,new j,r),s=s.toArray(),r=r.toArray(),void 0!==e.T&&Object.keys(e.T.curves).length>0){const t=this.generateVectorTrack(e.modelName,e.T.curves,s,"position");void 0!==t&&n.push(t)}if(void 0!==e.R&&Object.keys(e.R.curves).length>0){const t=this.generateRotationTrack(e.modelName,e.R.curves,e.preRotation,e.postRotation,e.eulerOrder);void 0!==t&&n.push(t)}if(void 0!==e.S&&Object.keys(e.S.curves).length>0){const t=this.generateVectorTrack(e.modelName,e.S.curves,r,"scale");void 0!==t&&n.push(t)}if(void 0!==e.DeformPercent){const t=this.generateMorphTrack(e);void 0!==t&&n.push(t)}return n}generateVectorTrack(e,t,n,s){const r=this.getTimesForAllAxes(t),i=this.getKeyframeTrackValues(r,t,n);return new G(e+"."+s,r,i)}generateRotationTrack(e,t,n,s,r){let i,o;if(void 0!==t.x&&void 0!==t.y&&void 0!==t.z){const e=this.interpolateRotations(t.x,t.y,t.z,r);i=e[0],o=e[1]}void 0!==n&&((n=n.map(T.degToRad)).push(r),n=(new U).fromArray(n),n=(new j).setFromEuler(n)),void 0!==s&&((s=s.map(T.degToRad)).push(r),s=(new U).fromArray(s),s=(new j).setFromEuler(s).invert());const a=new j,l=new U,c=[];if(!o||!i)return new V(e+".quaternion",[],[]);for(let h=0;h<o.length;h+=3){if(l.set(o[h],o[h+1],o[h+2],r),a.setFromEuler(l),void 0!==n&&a.premultiply(n),void 0!==s&&a.multiply(s),h>2){(new j).fromArray(c,(h-3)/3*4).dot(a)<0&&a.set(-a.x,-a.y,-a.z,-a.w)}a.toArray(c,h/3*4)}return new V(e+".quaternion",i,c)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,n=t.values.map((function(e){return e/100})),s=Le.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new W(e.modelName+".morphTargetInfluences["+s+"]",t.times,n)}getTimesForAllAxes(e){let t=[];if(void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort((function(e,t){return e-t})),t.length>1){let e=1,n=t[0];for(let s=1;s<t.length;s++){const r=t[s];r!==n&&(t[e]=r,n=r,e++)}t=t.slice(0,e)}return t}getKeyframeTrackValues(e,t,n){const s=n,r=[];let i=-1,o=-1,a=-1;return e.forEach((function(e){if(t.x&&(i=t.x.times.indexOf(e)),t.y&&(o=t.y.times.indexOf(e)),t.z&&(a=t.z.times.indexOf(e)),-1!==i){const e=t.x.values[i];r.push(e),s[0]=e}else r.push(s[0]);if(-1!==o){const e=t.y.values[o];r.push(e),s[1]=e}else r.push(s[1]);if(-1!==a){const e=t.z.values[a];r.push(e),s[2]=e}else r.push(s[2])})),r}interpolateRotations(e,t,n,s){const r=[],i=[];r.push(e.times[0]),i.push(T.degToRad(e.values[0])),i.push(T.degToRad(t.values[0])),i.push(T.degToRad(n.values[0]));for(let o=1;o<e.values.length;o++){const a=[e.values[o-1],t.values[o-1],n.values[o-1]];if(isNaN(a[0])||isNaN(a[1])||isNaN(a[2]))continue;const l=a.map(T.degToRad),c=[e.values[o],t.values[o],n.values[o]];if(isNaN(c[0])||isNaN(c[1])||isNaN(c[2]))continue;const h=c.map(T.degToRad),u=[c[0]-a[0],c[1]-a[1],c[2]-a[2]],p=[Math.abs(u[0]),Math.abs(u[1]),Math.abs(u[2])];if(p[0]>=180||p[1]>=180||p[2]>=180){const t=Math.max(...p)/180,n=new U(...l,s),a=new U(...h,s),c=(new j).setFromEuler(n),u=(new j).setFromEuler(a);c.dot(u)&&u.set(-u.x,-u.y,-u.z,-u.w);const d=e.times[o-1],f=e.times[o]-d,m=new j,g=new U;for(let e=0;e<1;e+=1/t)m.copy(c.clone().slerp(u.clone(),e)),r.push(d+e*f),g.setFromQuaternion(m,s),i.push(g.x),i.push(g.y),i.push(g.z)}else r.push(e.times[o]),i.push(T.degToRad(e.values[o])),i.push(T.degToRad(t.values[o])),i.push(T.degToRad(n.values[o]))}return[r,i]}}class Ue{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new Ge,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,n=e.split(/[\r\n]+/);return n.forEach((function(e,s){const r=e.match(/^[\s\t]*;/),i=e.match(/^[\s\t]*$/);if(r||i)return;const o=e.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),a=e.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),l=e.match("^\\t{"+(t.currentIndent-1)+"}}");o?t.parseNodeBegin(e,o):a?t.parseNodeProperty(e,a,n[++s]):l?t.popStack():e.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(e)})),this.allNodes}parseNodeBegin(e,t){const n=t[1].trim().replace(/^"/,"").replace(/"$/,""),s=t[2].split(",").map((function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")})),r={name:n},i=this.parseNodeAttr(s),o=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(n,r):n in o?("PoseNode"===n?o.PoseNode.push(r):void 0!==o[n].id&&(o[n]={},o[n][o[n].id]=o[n]),""!==i.id&&(o[n][i.id]=r)):"number"==typeof i.id?(o[n]={},o[n][i.id]=r):"Properties70"!==n&&(o[n]="PoseNode"===n?[r]:r),"number"==typeof i.id&&(r.id=i.id),""!==i.name&&(r.attrName=i.name),""!==i.type&&(r.attrType=i.type),this.pushStack(r)}parseNodeAttr(e){let t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let n="",s="";return e.length>1&&(n=e[1].replace(/^(\w+)::/,""),s=e[2]),{id:t,name:n,type:s}}parseNodeProperty(e,t,n){let s=t[1].replace(/^"/,"").replace(/"$/,"").trim(),r=t[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===s&&","===r&&(r=n.replace(/"/g,"").replace(/,$/,"").trim());const i=this.getCurrentNode();if("Properties70"!==i.name){if("C"===s){const e=r.split(",").slice(1),t=parseInt(e[0]),n=parseInt(e[1]);let o=r.split(",").slice(3);o=o.map((function(e){return e.trim().replace(/^"/,"")})),s="connections",r=[t,n],function(e,t){for(let n=0,s=e.length,r=t.length;n<r;n++,s++)e[s]=t[n]}(r,o),void 0===i[s]&&(i[s]=[])}"Node"===s&&(i.id=r),s in i&&Array.isArray(i[s])?i[s].push(r):"a"!==s?i[s]=r:i.a=r,this.setCurrentProp(i,s),"a"===s&&","!==r.slice(-1)&&(i.a=Ze(r))}else this.parseNodeSpecialProperty(e,s,r)}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=Ze(t.a))}parseNodeSpecialProperty(e,t,n){const s=n.split('",').map((function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")})),r=s[0],i=s[1],o=s[2],a=s[3];let l=s[4];switch(i){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":l=parseFloat(l);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":l=Ze(l)}this.getPrevNode()[r]={type:i,type2:o,flag:a,value:l},this.setCurrentProp(this.getPrevNode(),r)}}class Be{parse(e){const t=new je(e);t.skip(23);const n=t.getUint32();if(n<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+n);const s=new Ge;for(;!this.endOfContent(t);){const e=this.parseNode(t,n);null!==e&&s.add(e.name,e)}return s}endOfContent(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const n={},s=t>=7500?e.getUint64():e.getUint32(),r=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const i=e.getUint8(),o=e.getString(i);if(0===s)return null;const a=[];for(let u=0;u<r;u++)a.push(this.parseProperty(e));const l=a.length>0?a[0]:"",c=a.length>1?a[1]:"",h=a.length>2?a[2]:"";for(n.singleProperty=1===r&&e.getOffset()===s;s>e.getOffset();){const s=this.parseNode(e,t);null!==s&&this.parseSubNode(o,n,s)}return n.propertyList=a,"number"==typeof l&&(n.id=l),""!==c&&(n.attrName=c),""!==h&&(n.attrType=h),""!==o&&(n.name=o),n}parseSubNode(e,t,n){if(!0===n.singleProperty){const e=n.propertyList[0];Array.isArray(e)?(t[n.name]=n,n.a=e):t[n.name]=e}else if("Connections"===e&&"C"===n.name){const e=[];n.propertyList.forEach((function(t,n){0!==n&&e.push(t)})),void 0===t.connections&&(t.connections=[]),t.connections.push(e)}else if("Properties70"===n.name){Object.keys(n).forEach((function(e){t[e]=n[e]}))}else if("Properties70"===e&&"P"===n.name){let e=n.propertyList[0],s=n.propertyList[1];const r=n.propertyList[2],i=n.propertyList[3];let o;0===e.indexOf("Lcl ")&&(e=e.replace("Lcl ","Lcl_")),0===s.indexOf("Lcl ")&&(s=s.replace("Lcl ","Lcl_")),o="Color"===s||"ColorRGB"===s||"Vector"===s||"Vector3D"===s||0===s.indexOf("Lcl_")?[n.propertyList[4],n.propertyList[5],n.propertyList[6]]:n.propertyList[4],t[e]={type:s,type2:r,flag:i,value:o}}else void 0===t[n.name]?"number"==typeof n.id?(t[n.name]={},t[n.name][n.id]=n):t[n.name]=n:"PoseNode"===n.name?(Array.isArray(t[n.name])||(t[n.name]=[t[n.name]]),t[n.name].push(n)):void 0===t[n.name][n.id]&&(t[n.name][n.id]=n)}parseProperty(e){const t=e.getString(1);let n;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return n=e.getUint32(),e.getArrayBuffer(n);case"S":return n=e.getUint32(),e.getString(n);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const s=e.getUint32(),r=e.getUint32(),i=e.getUint32();if(0===r)switch(t){case"b":case"c":return e.getBooleanArray(s);case"d":return e.getFloat64Array(s);case"f":return e.getFloat32Array(s);case"i":return e.getInt32Array(s);case"l":return e.getInt64Array(s)}const o=function(e,t){return De((function(e){if(8!=(15&e[0])||e[0]>>>4>7||(e[0]<<8|e[1])%31)throw"invalid zlib data";if(32&e[1])throw"invalid zlib data: preset dictionaries not supported"}(e),e.subarray(2,-4)),t)}(new Uint8Array(e.getArrayBuffer(i))),a=new je(o.buffer);switch(t){case"b":case"c":return a.getBooleanArray(s);case"d":return a.getFloat64Array(s);case"f":return a.getFloat32Array(s);case"i":return a.getInt32Array(s);case"l":return a.getInt64Array(s)}break;default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class je{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t,this._textDecoder=new TextDecoder}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return!(1&~this.getUint8())}getBooleanArray(e){const t=[];for(let n=0;n<e;n++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,e=4294967295&~e,4294967295===e&&(t=t+1&4294967295),e=e+1&4294967295,-(4294967296*t+e)):4294967296*t+e}getInt64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){const t=this.offset;let n=new Uint8Array(this.dv.buffer,t,e);this.skip(e);const s=n.indexOf(0);return s>=0&&(n=new Uint8Array(this.dv.buffer,t,s)),this._textDecoder.decode(n)}}class Ge{add(e,t){this[e]=t}}function Ve(e){const t=e.match(/FBXVersion: (\d+)/);if(t){return parseInt(t[1])}throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function We(e){return e/46186158e3}const _e=[];function Xe(e,t,n,s){let r;switch(s.mappingType){case"ByPolygonVertex":r=e;break;case"ByPolygon":r=t;break;case"ByVertice":r=n;break;case"AllSame":r=s.indices[0]}"IndexToDirect"===s.referenceType&&(r=s.indices[r]);const i=r*s.dataSize,o=i+s.dataSize;return function(e,t,n,s){for(let r=n,i=0;r<s;r++,i++)e[i]=t[r];return e}(_e,s.buffer,i,o)}const He=new U,Ke=new t;function $e(e){const n=new m,s=new m,r=new m,i=new m,o=new m,a=new m,l=new m,c=new m,h=new m,u=new m,p=new m,d=new m,f=e.inheritType?e.inheritType:0;if(e.translation&&n.setPosition(Ke.fromArray(e.translation)),e.preRotation){const t=e.preRotation.map(T.degToRad);t.push(e.eulerOrder||U.DEFAULT_ORDER),s.makeRotationFromEuler(He.fromArray(t))}if(e.rotation){const t=e.rotation.map(T.degToRad);t.push(e.eulerOrder||U.DEFAULT_ORDER),r.makeRotationFromEuler(He.fromArray(t))}if(e.postRotation){const t=e.postRotation.map(T.degToRad);t.push(e.eulerOrder||U.DEFAULT_ORDER),i.makeRotationFromEuler(He.fromArray(t)),i.invert()}e.scale&&o.scale(Ke.fromArray(e.scale)),e.scalingOffset&&l.setPosition(Ke.fromArray(e.scalingOffset)),e.scalingPivot&&a.setPosition(Ke.fromArray(e.scalingPivot)),e.rotationOffset&&c.setPosition(Ke.fromArray(e.rotationOffset)),e.rotationPivot&&h.setPosition(Ke.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(p.copy(e.parentMatrix),u.copy(e.parentMatrixWorld));const g=s.clone().multiply(r).multiply(i),v=new m;v.extractRotation(u);const y=new m;y.copyPosition(u);const w=y.clone().invert().multiply(u),x=v.clone().invert().multiply(w),b=o,I=new m;if(0===f)I.copy(v).multiply(g).multiply(x).multiply(b);else if(1===f)I.copy(v).multiply(x).multiply(g).multiply(b);else{const e=(new m).scale((new t).setFromMatrixScale(p)).clone().invert(),n=x.clone().multiply(e);I.copy(v).multiply(g).multiply(n).multiply(b)}const D=h.clone().invert(),A=a.clone().invert();let P=n.clone().multiply(c).multiply(h).multiply(s).multiply(r).multiply(i).multiply(D).multiply(l).multiply(a).multiply(o).multiply(A);const E=(new m).copyPosition(P),R=u.clone().multiply(E);return d.copyPosition(R),P=d.clone().multiply(I),P.premultiply(u.invert()),P}function Ye(e){const t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?t[0]:t[e]}function Ze(e){return e.split(",").map((function(e){return parseFloat(e)}))}function qe(e,t,n){return void 0===t&&(t=0),void 0===n&&(n=e.byteLength),(new TextDecoder).decode(new Uint8Array(e,t,n))}class Qe{constructor(e,t){this.scene=e,this.data=t,this.type=t.type,this.speed=t.speed;const n=new H(1,2,1),s=new K({color:16711680});this.mesh=new E(n,s),this.mesh.position.set(t.position.x,t.position.y,t.position.z),e.add(this.mesh),"patrol"===this.type&&(this.patrolPoints=t.patrolPoints,this.currentPoint=0,this.direction=1),"chase"===this.type&&(this.detectionRange=t.detectionRange,this.isChasing=!1)}update(e){"patrol"===this.type?this.updatePatrol():"chase"===this.type&&this.updateChase(e)}updatePatrol(){const e=this.patrolPoints[this.currentPoint],n=this.mesh.position,s=new t(e.x-n.x,0,e.z-n.z);if(s.length()<.1)return 0!==this.currentPoint&&this.currentPoint!==this.patrolPoints.length-1||(this.direction*=-1),void(this.currentPoint=Math.max(0,Math.min(this.currentPoint+this.direction,this.patrolPoints.length-1)));s.normalize(),n.add(s.multiplyScalar(this.speed)),this.mesh.lookAt(e.x,n.y,e.z)}updateChase(e){const n=this.mesh.position,s=n.distanceTo(e);if(s<this.detectionRange?this.isChasing=!0:s>1.5*this.detectionRange&&(this.isChasing=!1),this.isChasing){const s=new t(e.x-n.x,0,e.z-n.z);s.normalize(),n.add(s.multiplyScalar(this.speed)),this.mesh.lookAt(e.x,n.y,e.z)}}checkCollision(e){return this.mesh.position.distanceTo(e)<1.5}}const Je=new q;Je.background=new p(8900331);const et=new b(75,window.innerWidth/window.innerHeight,.1,1e3);et.position.set(0,5,12),et.lookAt(0,0,0);const tt=document.getElementById("game-canvas");if(!tt)throw document.body.innerHTML='<div style="color: white; text-align: center; margin-top: 2em;">Unable to initialize game. Please refresh the page.</div>',new Error("Canvas element not found");const nt=new Q({canvas:tt,antialias:!0});nt.setSize(window.innerWidth,window.innerHeight),nt.setPixelRatio(window.devicePixelRatio),nt.shadowMap.enabled=!0,nt.shadowMap.type=J;const st=new N(16777215,.5);Je.add(st);const rt=new A(16777215,1);rt.position.set(5,5,5),rt.castShadow=!0,rt.shadow.mapSize.width=2048,rt.shadow.mapSize.height=2048,Je.add(rt);const it=new class{constructor(){this.createUIElements(),this.ringCount=0,this.totalRings=0,this.timeRemaining=60,this.timerInterval=null}createUIElements(){this.container=document.createElement("div"),this.container.style.position="fixed",this.container.style.top="20px",this.container.style.left="20px",this.container.style.color="white",this.container.style.fontFamily="Arial, sans-serif",this.container.style.fontSize="24px",this.container.style.textShadow="2px 2px 4px rgba(0,0,0,0.5)",document.body.appendChild(this.container),this.ringCounter=document.createElement("div"),this.ringCounter.textContent="Rings: 0/0",this.container.appendChild(this.ringCounter),this.timer=document.createElement("div"),this.timer.textContent="Time: 60s",this.container.appendChild(this.timer),this.messageDisplay=document.createElement("div"),this.messageDisplay.style.position="fixed",this.messageDisplay.style.top="50%",this.messageDisplay.style.left="50%",this.messageDisplay.style.transform="translate(-50%, -50%)",this.messageDisplay.style.color="white",this.messageDisplay.style.fontFamily="Arial, sans-serif",this.messageDisplay.style.fontSize="48px",this.messageDisplay.style.textShadow="2px 2px 4px rgba(0,0,0,0.5)",this.messageDisplay.style.display="none",document.body.appendChild(this.messageDisplay)}setTotalRings(e){this.totalRings=e,this.updateRingCounter()}updateRingCounter(){this.ringCounter.textContent=`Rings: ${this.ringCount}/${this.totalRings}`}incrementRings(){return this.ringCount++,this.updateRingCounter(),this.ringCount===this.totalRings&&(this.showMessage("Level Complete!","green"),this.stopTimer(),!0)}startTimer(e=60){this.timeRemaining=e,this.updateTimer(),this.timerInterval&&clearInterval(this.timerInterval),this.timerInterval=setInterval((()=>{if(this.timeRemaining--,this.updateTimer(),this.timeRemaining<=0)return this.stopTimer(),this.showMessage("Time's Up!","red"),!0}),1e3)}updateTimer(){this.timer.textContent=`Time: ${this.timeRemaining}s`}stopTimer(){this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null)}showMessage(e,t="white"){this.messageDisplay.textContent=e,this.messageDisplay.style.color=t,this.messageDisplay.style.display="block"}hideMessage(){this.messageDisplay.style.display="none"}reset(){this.ringCount=0,this.updateRingCounter(),this.hideMessage(),this.stopTimer()}showError(e="Something went wrong. Please refresh the page."){this.showMessage(e,"#ff4444")}},ot=new class{constructor(e,t){this.scene=e,this.ui=t,this.rings=[],this.enemies=[],this.obstacles=[],this.platforms=[],this.levelData=null}async loadLevel(e){try{const t=await fetch(`/data/level${e}.json`);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return this.levelData=await t.json(),this.setupEnvironment(),this.createTerrain(),this.createRings(),this.createEnemies(),this.ui.setTotalRings(this.levelData.rings.length),this.ui.reset(),this.ui.startTimer(60),this.levelData.playerStart}catch(t){throw this.ui.showError("Unable to load level. Please refresh the page."),t}}setupEnvironment(){this.scene.background=new p(this.levelData.environment.skyColor),this.ground&&this.scene.remove(this.ground);const e=new $(this.levelData.environment.groundSize.width,this.levelData.environment.groundSize.depth),t=new K({color:new p(this.levelData.environment.groundColor),roughness:.8});this.ground=new E(e,t),this.ground.rotation.x=-Math.PI/2,this.scene.add(this.ground)}createTerrain(){this.obstacles.forEach((e=>this.scene.remove(e))),this.platforms.forEach((e=>this.scene.remove(e))),this.obstacles=[],this.platforms=[],this.levelData.terrain&&(this.levelData.terrain.platforms&&this.levelData.terrain.platforms.forEach((e=>{let t;("platform"===e.type||"ramp"===e.type)&&(t=new H(e.size.width,e.size.height,e.size.depth));const n=new K({color:new p(e.color),roughness:.7}),s=new E(t,n);s.position.set(e.position.x,e.position.y,e.position.z),s.rotation.set(T.degToRad(e.rotation.x),T.degToRad(e.rotation.y),T.degToRad(e.rotation.z)),this.scene.add(s),this.platforms.push(s)})),this.levelData.terrain.obstacles&&this.levelData.terrain.obstacles.forEach((e=>{let t;"box"===e.type?t=new H(e.size.width,e.size.height,e.size.depth):"cylinder"===e.type&&(t=new Y(e.size.radius,e.size.radius,e.size.height,32));const n=new K({color:new p(e.color),roughness:.5}),s=new E(t,n);s.position.set(e.position.x,e.position.y,e.position.z),s.rotation.set(T.degToRad(e.rotation.x),T.degToRad(e.rotation.y),T.degToRad(e.rotation.z)),this.scene.add(s),this.obstacles.push(s)})))}createRings(){this.rings.forEach((e=>this.scene.remove(e))),this.rings=[];const e=new Z(1,.1,16,32),t=new K({color:16766720,metalness:.7,roughness:.3});this.levelData.rings.forEach((n=>{const s=new E(e,t);s.position.set(n.position.x,n.position.y,n.position.z),s.rotation.set(T.degToRad(n.rotation.x),T.degToRad(n.rotation.y),T.degToRad(n.rotation.z)),this.scene.add(s),this.rings.push(s)}))}createEnemies(){this.enemies.forEach((e=>this.scene.remove(e.mesh))),this.enemies=[],this.levelData.enemies&&this.levelData.enemies.forEach((e=>{const t=new Qe(this.scene,e);this.enemies.push(t)}))}update(e){this.enemies.forEach((t=>{t.update(e)})),this.checkRingCollisions(e);const t=this.checkEnemyCollisions(e);return t&&(this.ui.showMessage("Game Over!","red"),this.ui.stopTimer()),t}checkRingCollisions(e){this.rings.forEach(((t,n)=>{if(!this.levelData.rings[n].collected){e.distanceTo(t.position)<1.5&&(this.levelData.rings[n].collected=!0,t.visible=!1,this.ui.incrementRings())}}))}checkEnemyCollisions(e){return this.enemies.some((t=>t.checkCollision(e)))}reset(){this.rings.forEach(((e,t)=>{e.visible=!0,this.levelData.rings[t]&&(this.levelData.rings[t].collected=!1)})),this.ui.reset(),this.ui.startTimer(60)}}(Je,it),at=new class{constructor(e){this.scene=e,this.mesh=null,this.mixer=null,this.animations={},this.currentAction=null,this.speed=.15,this.turnSpeed=.05,this.velocity=new t,this.direction=new t,this.loadModel()}async loadModel(){const e=new Me;try{const n=await e.loadAsync("/memory-bank/Stegasaurus_20K.fbx");n.scale.setScalar(.01),n.position.y=0,n.animations.length>0&&(this.mixer=new _(n),n.animations.forEach((e=>{this.animations[e.name]=this.mixer.clipAction(e)})),this.animations.idle&&this.playAnimation("idle")),this.mesh=n,this.scene.add(n);const s=(new X).setFromObject(n).getSize(new t);this.collider=new X,this.colliderSize=s}catch(n){}}playAnimation(e){this.currentAction&&this.currentAction.fadeOut(.2),this.animations[e]&&(this.animations[e].reset().fadeIn(.2).play(),this.currentAction=this.animations[e])}update(e,t){this.mesh&&(this.mixer&&this.mixer.update(e),this.velocity.x=0,this.velocity.z=0,t.w&&(this.velocity.z=-this.speed),t.s&&(this.velocity.z=this.speed),t.a&&(this.mesh.rotation.y+=this.turnSpeed),t.d&&(this.mesh.rotation.y-=this.turnSpeed),this.direction.set(0,0,1).applyQuaternion(this.mesh.quaternion),this.mesh.position.addScaledVector(this.direction,this.velocity.z),this.collider&&this.collider.setFromCenterAndSize(this.mesh.position,this.colliderSize),this.velocity.length()>0?this.playAnimation("walk"):this.playAnimation("idle"))}getPosition(){return this.mesh?this.mesh.position:new t}reset(e){this.mesh&&(this.mesh.position.copy(e),this.mesh.rotation.set(0,0,0))}}(Je);let lt=!1,ct=new ee;const ht={w:!1,a:!1,s:!1,d:!1};function ut(){lt=!1,ot.reset(),pt()}async function pt(){try{const e=await ot.loadLevel(1);at.mesh&&at.reset(new t(e.x,e.y,e.z)),it.hideMessage()}catch(e){it.showError("Unable to load level. Please refresh the page.")}}function dt(){if(requestAnimationFrame(dt),!lt){const e=ct.getDelta();at.update(e,ht);const n=at.getPosition();ot.update(n)&&(lt=!0,setTimeout(ut,1500));const s=new t(0,5,12),r=new t(0,0,0),i=at.mesh?at.mesh.rotation.y:0;s.applyAxisAngle(new t(0,1,0),i),r.applyAxisAngle(new t(0,1,0),i),s.add(n),r.add(n),et.position.lerp(s,.1);const o=new t;o.copy(n).add(new t(0,1,0)),et.lookAt(o)}nt.render(Je,et)}window.addEventListener("keydown",(e=>{switch(e.key.toLowerCase()){case"w":ht.w=!0;break;case"a":ht.a=!0;break;case"s":ht.s=!0;break;case"d":ht.d=!0}})),window.addEventListener("keyup",(e=>{switch(e.key.toLowerCase()){case"w":ht.w=!1;break;case"a":ht.a=!1;break;case"s":ht.s=!1;break;case"d":ht.d=!1}})),window.addEventListener("resize",(()=>{et.aspect=window.innerWidth/window.innerHeight,et.updateProjectionMatrix(),nt.setSize(window.innerWidth,window.innerHeight)})),window.addEventListener("error",(e=>{it.showError(),e.preventDefault()})),pt().then((()=>{dt()})).catch((()=>{it.showError()}));
//# sourceMappingURL=index-38jbrNpp.js.map
